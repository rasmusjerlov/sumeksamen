@{
    ViewData["Title"] = "Spisesal";
}

<h1>Bordopsætning</h1>

@model List<SumEksamen.Models.Bord>

<div>
    <form id="distributeStudentsForm" method="post" action="/Bord/TilfojElevTilBordFraVenteliste">
        <label for="aargang">Vælg årgang:</label>
        <select id="aargang" name="aargang" required>
            @foreach (var aargang in ViewBag.AargangList)
            {
                <option value="@aargang">@aargang</option>
            }
        </select>
        <button type="submit">Fordel Elever</button>
    </form>
</div>

<div class="layout" id="layout">
    @for (int i = 0; i < Model.Count; i++)
    {
        var bord = Model[i];
        <div class="bord-container">
            <div class="bord" id="bord-@bord.bordNr" onclick="editBord(@bord.bordNr, @bord.antalPladser)">
                <div class="bord-nummer">Bord @bord.bordNr</div>

                @{
                    int pladserPerSide = bord.antalPladser / 2;
                    int extraSeat = bord.antalPladser % 2;
                    int elevIndex = 0;

                    for (int j = 0; j < pladserPerSide + extraSeat; j++)
                    {
                        double venstre = (j + 1) * (100 / (pladserPerSide + extraSeat + 1));
                        var elev = bord.elever.ElementAtOrDefault(elevIndex++);
                        string elevStyle = elev != null ? (elev.Køn == Køn.pige ? "background-color: pink;" : "background-color: darkblue;") : "";
                        string elevName = elev != null ? elev.Navn : "";
                        <div class="plads" style="top: -15px; left: @($"{venstre}%"); @elevStyle" title="@elevName" draggable="true" ondragstart="drag(event)" id="elev-@elev?.Navn"></div>
                    }

                    for (int j = 0; j < pladserPerSide; j++)
                    {
                        double venstre = (j + 1) * (100 / (pladserPerSide + 1));
                        var elev = bord.elever.ElementAtOrDefault(elevIndex++);
                        string elevStyle = elev != null ? (elev.Køn == Køn.pige ? "background-color: pink;" : "background-color: darkblue;") : "";
                        string elevName = elev != null ? elev.Navn : "";
                        <div class="plads" style="bottom: -15px; left: @($"{venstre}%"); @elevStyle" title="@elevName" draggable="true" ondragstart="drag(event)" id="elev-@elev?.Navn"></div>
                    }
                }
            </div>
            <form method="post" action="/Bord/SletBord" style="display:inline;">
                <input type="hidden" name="bordNr" value="@bord.bordNr">
                <button type="submit">Slet</button>
            </form>
            <div class="elev-liste">
                <h3>Elever ved bordet:</h3>
                <ul>
                    @foreach (var elev in bord.elever)
                    {
                        <li>@elev.Navn (@elev.Køn)</li>
                    }
                </ul>
            </div>
        </div>
    }
</div>

<div id="editForm" style="display:none;">
    <h2>Edit Bord</h2>
    <form id="editBordForm" method="post" action="/Bord/UpdateBord">
        <input type="hidden" id="bordNr" name="bordNr">
        <label for="antalPladser">Antal Pladser:</label>
        <input type="number" id="antalPladser" name="antalPladser" required><br>
        <button type="submit">Save</button>
        <button type="button" onclick="cancelEdit()">Cancel</button>
    </form>
</div>

<div id="createForm">
    <h2>Opret Bord</h2>
    <form id="createBordForm" method="post" action="/Bord/OpretBord">
        <label for="bordNr">Bord Nr:</label>
        <input type="number" id="bordNr" name="bordNr" required><br>
        <label for="antalPladser">Antal Pladser:</label>
        <input type="number" id="antalPladser" name="antalPladser" required><br>
        <button type="submit">Opret</button>
    </form>
</div>

<style>
    .layout {
        display: flex;
        flex-wrap: wrap;
        gap: 40px;
        padding: 20px;
    }

    .bord-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .bord {
        position: relative;
        width: 150px;
        height: 80px;
        background-color: #4b98af;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: pointer;
    }

    .plads {
        width: 20px;
        height: 20px;
        background-color: #9bd1e3;
        border-radius: 50%;
        position: absolute;
    }

    .plads:hover {
        background-color: #5a6f77;
        cursor: pointer;
    }

    .bord-nummer {
        font-weight: bold;
        color: white;
        text-align: center;
        position: absolute;
    }

    .bord-container form {
        margin-top: 20px;
    }

    .inline-form label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-right: 10px;
    }
</style>

<script>
    function editBord(bordNr, antalPladser) {
        document.getElementById('editForm').style.display = 'block';
        document.getElementById('bordNr').value = bordNr;
        document.getElementById('antalPladser').value = antalPladser;
    }

    function cancelEdit() {
        document.getElementById('editForm').style.display = 'none';
    }

    document.getElementById('createBordForm').addEventListener('submit', function (event) {
        event.preventDefault();
        var formData = new FormData(event.target);

        fetch('/Bord/OpretBord', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error creating bord:', error));
    });

    function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drop(event) {
        event.preventDefault();
        var data = event.dataTransfer.getData("text");
        var draggedElement = document.getElementById(data);
        var targetElement = event.target;

        if (targetElement.classList.contains("plads")) {
            var tempId = targetElement.id;
            targetElement.id = draggedElement.id;
            draggedElement.id = tempId;

            var tempTitle = targetElement.title;
            targetElement.title = draggedElement.title;
            draggedElement.title = tempTitle;

            var tempStyle = targetElement.style.backgroundColor;
            targetElement.style.backgroundColor = draggedElement.style.backgroundColor;
            draggedElement.style.backgroundColor = tempStyle;
        }
    }

    document.querySelectorAll('.plads').forEach(function (plads) {
        plads.addEventListener('dragover', allowDrop);
        plads.addEventListener('drop', drop);
    });
</script>